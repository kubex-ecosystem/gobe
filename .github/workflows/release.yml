name: ðŸš€ Gobe Multi-Platform Release

on:
  push:
    tags:
      - "v*.*.*" 
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for manual release (e.g., v1.0.0)'
        required: false
        type: string

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  # ==========================================
  # JOB 1: Build All Platforms  
  # ==========================================
  build:
    name: ðŸ—ï¸ Cross-Platform Build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      go-version: ${{ steps.go-setup.outputs.go-version }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Extract Version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.tag_name }}" ]]; then
            echo "version=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ” Validate Tag Format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: vX.Y.Z (e.g., v1.2.3)"
            exit 1
          fi
          echo "âœ… Valid version: $VERSION"

      - name: ðŸ¹ Smart Go Setup
        id: go-setup
        run: |
          echo "ðŸ” Detecting Go version from go.mod..."
          GO_VERSION=$(grep '^go ' go.mod | awk '{print $2}')
          echo "ðŸ“¦ Detected Go version: $GO_VERSION"
          
          echo "ðŸš€ Installing Go $GO_VERSION using your custom script..."
          bash -c "$(curl -sSfL 'https://raw.githubusercontent.com/rafa-mori/gosetup/main/go.sh')" -s --version "$GO_VERSION"
          
          # Verify installation
          go version
          echo "âœ… Go setup completed successfully!"
          
          # Output for other jobs
          echo "go-version=$GO_VERSION" >> $GITHUB_OUTPUT

      - name: ðŸ—ƒï¸ Cache Go Modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ steps.go-setup.outputs.go-version }}-${{ hashFiles('**/go.sum', '**/go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-${{ steps.go-setup.outputs.go-version }}-

      - name: ðŸ§ Build Linux AMD64
        run: |
          echo "ðŸš€ Building Linux AMD64..."
          make build linux amd64
          echo "âœ… Linux build completed!"

      - name: ðŸªŸ Build Windows AMD64  
        run: |
          echo "ðŸš€ Building Windows AMD64..."
          make build windows amd64
          echo "âœ… Windows build completed!"

      - name: ðŸŽ Build macOS AMD64
        run: |
          echo "ðŸš€ Building macOS AMD64..."
          make build darwin amd64  
          echo "âœ… macOS build completed!"

      - name: ðŸ“¦ Verify Build Artifacts
        run: |
          echo "ðŸ“¦ Build artifacts created:"
          ls -la bin/
          
          echo "ðŸ” Generating checksums..."
          cd bin
          sha256sum gobe-* > SHA256SUMS
          echo "âœ… Checksums generated!"
          ls -la

      - name: ðŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gobe-release-binaries
          path: |
            bin/gobe-*
          retention-days: 30

  # ==========================================
  # JOB 2: Security Scan (Optional)
  # ==========================================
  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name != 'workflow_dispatch'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ¹ Smart Go Setup
        run: |
          echo "ðŸ” Detecting Go version from go.mod..."
          GO_VERSION=$(grep '^go ' go.mod | awk '{print $2}')
          echo "ðŸ“¦ Using Go version: $GO_VERSION"
          
          echo "ðŸš€ Installing Go $GO_VERSION using custom script..."
          bash -c "$(curl -sSfL 'https://raw.githubusercontent.com/rafa-mori/gosetup/main/go.sh')" -s --version "$GO_VERSION"
          
          # Verify installation
          go version
          echo "âœ… Go setup completed!"

      - name: ðŸ—ƒï¸ Restore Go Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ needs.build.outputs.go-version }}-${{ hashFiles('**/go.sum', '**/go.mod') }}

      - name: ðŸ” Run Gosec Security Scanner
        run: |
          echo "ðŸ” Installing and running Gosec..."
          go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
          gosec -no-fail -fmt sarif -out gosec.sarif ./...
          echo "âœ… Security scan completed!"

      - name: ðŸ“Š Upload SARIF file
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gosec.sarif

  # ==========================================
  # JOB 3: Create GitHub Release
  # ==========================================
  release:
    name: ðŸŽ‰ Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: always() && needs.build.result == 'success'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: gobe-release-binaries
          path: ./release-assets

      - name: ðŸ“ Generate Release Notes
        run: |
          VERSION="${{ needs.build.outputs.version }}"
          
          # Create comprehensive release notes
          cat > RELEASE_NOTES.md << 'EOF'
          ## ðŸš€ Gobe Release ${{ needs.build.outputs.version }}
          
          ### ðŸ“¦ What's Included
          
          This release contains cross-platform binaries for:
          
          - ðŸ§ **Linux (AMD64)**: `gobe-linux-amd64.tar.gz`
          - ðŸªŸ **Windows (AMD64)**: `gobe-windows-amd64.zip`  
          - ðŸŽ **macOS (AMD64)**: `gobe-darwin-amd64.tar.gz`
          
          ### ðŸ“¥ Installation
          
          #### Linux/macOS
          ```bash
          # Download and extract
          wget https://github.com/${{ github.repository }}/releases/download/${{ needs.build.outputs.version }}/gobe-linux-amd64.tar.gz
          tar -xzf gobe-linux-amd64.tar.gz
          chmod +x gobe-linux-amd64
          sudo mv gobe-linux-amd64 /usr/local/bin/gobe
          ```
          
          #### Windows
          ```powershell
          # Download and extract the ZIP file
          # Add the executable to your PATH
          ```
          
          ### ðŸ” Verification
          
          All binaries are compressed and checksums are provided in `SHA256SUMS`.
          
          ```bash
          # Verify checksum
          sha256sum -c SHA256SUMS
          ```
          
          ### ðŸ“Š Build Information
          
          - **Go Version**: ${{ needs.build.outputs.go-version }}
          - **Built on**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **Commit**: ${{ github.sha }}
          - **Workflow**: ${{ github.run_id }}
          
          ---
          
          **Full Changelog**: [${{ github.repository }}/compare/...](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }})
          EOF

      - name: ðŸŽ‰ Create GitHub Release
        run: |
          echo "ðŸŽ‰ Creating GitHub Release..."
          
          # Create release using GitHub CLI
          gh release create "${{ needs.build.outputs.version }}" \
            ./release-assets/* \
            --title "ðŸš€ Gobe ${{ needs.build.outputs.version }}" \
            --notes-file RELEASE_NOTES.md \
            ${{ contains(needs.build.outputs.version, '-') && '--prerelease' || '' }}
          
          echo "âœ… Release created successfully!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¢ Release Summary
        run: |
          echo "## ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Go Version**: ${{ needs.build.outputs.go-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Assets Released:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ Linux AMD64" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸªŸ Windows AMD64" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ macOS AMD64" >> $GITHUB_STEP_SUMMARY